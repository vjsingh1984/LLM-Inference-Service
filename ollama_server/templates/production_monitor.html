{% extends "base.html" %}

{% block title %}Production Monitor - LLM Inference Service{% endblock %}

{% block content %}
<div class="row">
    <!-- System Health Overview -->
    <div class="col-12 mb-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i>
                    Production System Health
                    <button class="btn btn-outline-success btn-sm ms-2" onclick="refreshProductionData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="health-score">--</div>
                            <div class="metric-label">System Health Score</div>
                            <small class="text-white-50">Overall system performance rating</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Uptime</h5>
                                <h3 class="text-primary" id="system-uptime">--</h3>
                                <small class="text-muted">Hours operational</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Active Alerts</h5>
                                <h3 id="active-alerts-count" class="text-warning">--</h3>
                                <small class="text-muted">Requiring attention</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Request Success Rate</h5>
                                <h3 id="success-rate" class="text-success">--</h3>
                                <small class="text-muted">Last 24 hours</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Charts -->
    <div class="col-12 mb-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    Performance Metrics
                    <div class="btn-group btn-group-sm ms-auto" role="group">
                        <input type="radio" class="btn-check" name="timeRange" id="range1h" value="1">
                        <label class="btn btn-outline-primary" for="range1h">1H</label>
                        
                        <input type="radio" class="btn-check" name="timeRange" id="range6h" value="6" checked>
                        <label class="btn btn-outline-primary" for="range6h">6H</label>
                        
                        <input type="radio" class="btn-check" name="timeRange" id="range24h" value="24">
                        <label class="btn btn-outline-primary" for="range24h">24H</label>
                    </div>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="responseTimeChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="errorRateChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="throughputChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Alerts -->
    <div class="col-md-8 mb-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Active Alerts
                    <span class="badge bg-warning ms-2" id="alerts-badge">0</span>
                </h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="active-alerts-container">
                    <div class="text-center py-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-success">All Systems Normal</h5>
                        <p class="text-muted">No active alerts detected.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Statistics -->
    <div class="col-md-4 mb-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i>
                    Real-time Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">Total Requests</small>
                    <h4 id="total-requests" class="mb-0">--</h4>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Avg Response Time</small>
                    <h4 id="avg-response-time" class="mb-0">--</h4>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Tokens Generated</small>
                    <h4 id="total-tokens" class="mb-0">--</h4>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Peak Concurrent</small>
                    <h4 id="peak-concurrent" class="mb-0">--</h4>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Throughput</small>
                    <h4 id="tokens-per-second" class="mb-0">--</h4>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Production Log Viewer -->
    <div class="col-12 mb-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-text"></i>
                    Production Log Monitor
                    <div class="btn-group btn-group-sm ms-auto">
                        <button class="btn btn-outline-secondary" onclick="clearLogView()">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportLogs()">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="log-level-filter">
                            <option value="">All Levels</option>
                            <option value="ERROR">Errors Only</option>
                            <option value="WARNING">Warnings+</option>
                            <option value="INFO">Info+</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="log-search" placeholder="Search logs...">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
                            <label class="form-check-label" for="auto-scroll">
                                Auto-scroll to bottom
                            </label>
                        </div>
                    </div>
                </div>
                <div id="log-container" style="height: 300px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                    <div class="text-muted">Log monitoring starting...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Configuration -->
    <div class="col-12 mb-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Alert Thresholds Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Warning</th>
                                        <th>Critical</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="alert-thresholds-table">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="resetDefaultThresholds()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                            </button>
                            <button class="btn btn-outline-success" onclick="exportConfiguration()">
                                <i class="bi bi-download"></i> Export Configuration
                            </button>
                            <button class="btn btn-outline-warning" onclick="testAlertSystem()">
                                <i class="bi bi-bell"></i> Test Alert System
                            </button>
                        </div>
                        
                        <h6 class="mt-4">Alert History</h6>
                        <div id="alert-history" style="max-height: 200px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Configuration Modal -->
<div class="modal fade" id="alertConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Alert Threshold</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alert-config-form">
                    <input type="hidden" id="metric-name">
                    <div class="mb-3">
                        <label for="warning-threshold" class="form-label">Warning Threshold</label>
                        <input type="number" class="form-control" id="warning-threshold" step="0.1">
                    </div>
                    <div class="mb-3">
                        <label for="critical-threshold" class="form-label">Critical Threshold</label>
                        <input type="number" class="form-control" id="critical-threshold" step="0.1">
                    </div>
                    <div class="mb-3">
                        <label for="duration-seconds" class="form-label">Duration (seconds)</label>
                        <input type="number" class="form-control" id="duration-seconds" min="30" max="3600">
                        <div class="form-text">How long threshold must be exceeded before alerting</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="threshold-enabled">
                            <label class="form-check-label" for="threshold-enabled">
                                Enable this alert
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAlertThreshold()">Save Threshold</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Production monitoring JavaScript
let productionData = {};
let performanceChart, responseTimeChart, errorRateChart, throughputChart;
let productionInterval;
let logLines = [];

// Initialize production monitoring
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    startProductionMonitoring();
    setupLogMonitoring();
    
    // Time range selector
    document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateChartsTimeRange(this.value);
        });
    });
});

function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                type: 'time',
                time: {
                    unit: 'minute'
                }
            },
            y: {
                beginAtZero: true
            }
        },
        elements: {
            point: {
                radius: 2
            },
            line: {
                tension: 0.4
            }
        }
    };
    
    // Performance Chart (CPU, Memory, GPU)
    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(perfCtx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'CPU Usage %',
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    data: []
                },
                {
                    label: 'Memory Usage %',
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40,167,69,0.1)',
                    data: []
                },
                {
                    label: 'GPU Utilization %',
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255,193,7,0.1)',
                    data: []
                }
            ]
        },
        options: {
            ...chartOptions,
            plugins: {
                title: {
                    display: true,
                    text: 'System Resource Usage'
                }
            }
        }
    });
    
    // Response Time Chart
    const respCtx = document.getElementById('responseTimeChart').getContext('2d');
    responseTimeChart = new Chart(respCtx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Response Time (ms)',
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220,53,69,0.1)',
                data: []
            }]
        },
        options: {
            ...chartOptions,
            plugins: {
                title: {
                    display: true,
                    text: 'Average Response Time'
                }
            }
        }
    });
    
    // Error Rate Chart
    const errorCtx = document.getElementById('errorRateChart').getContext('2d');
    errorRateChart = new Chart(errorCtx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Error Rate %',
                borderColor: '#e83e8c',
                backgroundColor: 'rgba(232,62,140,0.1)',
                data: []
            }]
        },
        options: {
            ...chartOptions,
            plugins: {
                title: {
                    display: true,
                    text: 'Error Rate Percentage'
                }
            }
        }
    });
    
    // Throughput Chart
    const throughputCtx = document.getElementById('throughputChart').getContext('2d');
    throughputChart = new Chart(throughputCtx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Requests/min',
                    borderColor: '#6f42c1',
                    backgroundColor: 'rgba(111,66,193,0.1)',
                    data: []
                },
                {
                    label: 'Tokens/sec',
                    borderColor: '#20c997',
                    backgroundColor: 'rgba(32,201,151,0.1)',
                    data: []
                }
            ]
        },
        options: {
            ...chartOptions,
            plugins: {
                title: {
                    display: true,
                    text: 'System Throughput'
                }
            }
        }
    });
}

async function startProductionMonitoring() {
    async function updateProductionData() {
        try {
            const response = await fetch('/api/metrics/production');
            if (!response.ok) throw new Error('Failed to fetch production data');
            
            productionData = await response.json();
            updateProductionDisplay();
        } catch (error) {
            console.error('Error fetching production data:', error);
            showProductionError(error.message);
        }
    }
    
    // Update immediately and then every 30 seconds
    updateProductionData();
    productionInterval = setInterval(updateProductionData, 30000);
}

function updateProductionDisplay() {
    if (!productionData || productionData.error) {
        showProductionError(productionData?.error || 'Unknown error');
        return;
    }
    
    const summary = productionData.summary || {};
    
    // Update health score
    updateHealthScore(summary.system_health_score || 0);
    
    // Update summary stats
    DashboardUtils.updateElementSafely('system-uptime', `${(summary.uptime_hours || 0).toFixed(1)}h`);
    DashboardUtils.updateElementSafely('active-alerts-count', summary.active_alerts?.length || 0);
    DashboardUtils.updateElementSafely('total-requests', DashboardUtils.formatNumber(summary.total_requests || 0));
    DashboardUtils.updateElementSafely('avg-response-time', `${(summary.average_response_time_ms || 0).toFixed(0)}ms`);
    DashboardUtils.updateElementSafely('total-tokens', DashboardUtils.formatNumber(summary.total_tokens_generated || 0));
    DashboardUtils.updateElementSafely('peak-concurrent', summary.peak_concurrent_requests || 0);
    DashboardUtils.updateElementSafely('tokens-per-second', `${(summary.average_tokens_per_second || 0).toFixed(1)}/s`);
    
    // Calculate success rate
    const totalReqs = summary.total_requests || 0;
    const successReqs = summary.successful_requests || 0;
    const successRate = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(1) : 100;
    DashboardUtils.updateElementSafely('success-rate', `${successRate}%`);
    
    // Update alerts
    updateActiveAlerts(summary.active_alerts || []);
    
    // Update charts
    updatePerformanceCharts(productionData.recent_metrics || []);
}

function updateHealthScore(score) {
    const scoreElement = document.getElementById('health-score');
    const card = scoreElement.closest('.metric-card');
    
    scoreElement.textContent = score.toFixed(1);
    
    // Update color based on score
    if (score >= 80) {
        card.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    } else if (score >= 60) {
        card.style.background = 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)';
    } else {
        card.style.background = 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
    }
}

function updateActiveAlerts(alerts) {
    const container = document.getElementById('active-alerts-container');
    const badge = document.getElementById('alerts-badge');
    
    badge.textContent = alerts.length;
    
    if (alerts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-success">All Systems Normal</h5>
                <p class="text-muted">No active alerts detected.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    alerts.forEach(alert => {
        const alertClass = alert.alert_type === 'critical' ? 'danger' : 'warning';
        const icon = alert.alert_type === 'critical' ? 'exclamation-triangle-fill' : 'exclamation-triangle';
        
        html += `
            <div class="alert alert-${alertClass} d-flex align-items-center" role="alert">
                <i class="bi bi-${icon} me-2"></i>
                <div class="flex-grow-1">
                    <strong>${alert.metric_name.replace('_', ' ').toUpperCase()}</strong>
                    <div>${alert.message}</div>
                    <small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                </div>
                <button class="btn btn-outline-${alertClass} btn-sm" onclick="dismissAlert('${alert.id}')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updatePerformanceCharts(metrics) {
    if (!metrics || metrics.length === 0) return;
    
    // Prepare data for charts
    const timestamps = metrics.map(m => new Date(m.timestamp));
    
    // Performance chart data
    performanceChart.data.datasets[0].data = metrics.map((m, i) => ({x: timestamps[i], y: m.cpu_usage_percent}));
    performanceChart.data.datasets[1].data = metrics.map((m, i) => ({x: timestamps[i], y: m.memory_usage_percent}));
    performanceChart.data.datasets[2].data = metrics.map((m, i) => ({x: timestamps[i], y: m.gpu_utilization_avg}));
    performanceChart.update('none');
    
    // Response time chart
    responseTimeChart.data.datasets[0].data = metrics.map((m, i) => ({x: timestamps[i], y: m.average_response_time_ms}));
    responseTimeChart.update('none');
    
    // Error rate chart
    errorRateChart.data.datasets[0].data = metrics.map((m, i) => ({x: timestamps[i], y: m.error_rate_percent}));
    errorRateChart.update('none');
    
    // Throughput chart
    throughputChart.data.datasets[0].data = metrics.map((m, i) => ({x: timestamps[i], y: m.completed_requests_per_minute}));
    throughputChart.data.datasets[1].data = metrics.map((m, i) => ({x: timestamps[i], y: m.tokens_per_second}));
    throughputChart.update('none');
}

function setupLogMonitoring() {
    // Simulate log entries (in real implementation, this would be websocket or polling)
    const logContainer = document.getElementById('log-container');
    
    function addLogEntry(level, message, timestamp = new Date()) {
        const entry = {
            timestamp: timestamp.toISOString(),
            level: level,
            message: message
        };
        
        logLines.push(entry);
        
        // Keep only last 1000 entries
        if (logLines.length > 1000) {
            logLines.shift();
        }
        
        updateLogDisplay();
    }
    
    // Add some initial log entries
    addLogEntry('INFO', 'Production monitoring system started');
    addLogEntry('INFO', 'GPU monitoring initialized - 4x Tesla M10 detected');
    addLogEntry('INFO', 'Model discovery completed - 52 models available');
    
    // Simulate periodic log entries
    setInterval(() => {
        const messages = [
            'Request processed successfully',
            'Model cache updated',
            'GPU temperature check passed',
            'Performance metrics collected',
            'Health check completed'
        ];
        
        const levels = ['INFO', 'DEBUG', 'INFO', 'INFO', 'INFO'];
        const randomIndex = Math.floor(Math.random() * messages.length);
        
        addLogEntry(levels[randomIndex], messages[randomIndex]);
    }, 15000);
}

function updateLogDisplay() {
    const container = document.getElementById('log-container');
    const levelFilter = document.getElementById('log-level-filter').value;
    const searchFilter = document.getElementById('log-search').value.toLowerCase();
    const autoScroll = document.getElementById('auto-scroll').checked;
    
    const levelPriority = {'DEBUG': 0, 'INFO': 1, 'WARNING': 2, 'ERROR': 3};
    const minLevel = levelFilter ? levelPriority[levelFilter] : 0;
    
    let filteredLines = logLines.filter(line => {
        const levelMatch = levelPriority[line.level] >= minLevel;
        const searchMatch = !searchFilter || line.message.toLowerCase().includes(searchFilter);
        return levelMatch && searchMatch;
    });
    
    // Keep only last 100 for display
    filteredLines = filteredLines.slice(-100);
    
    let html = '';
    filteredLines.forEach(line => {
        const levelClass = {
            'ERROR': 'text-danger',
            'WARNING': 'text-warning', 
            'INFO': 'text-info',
            'DEBUG': 'text-muted'
        }[line.level] || 'text-muted';
        
        const timestamp = new Date(line.timestamp).toLocaleTimeString();
        html += `<div class="mb-1"><span class="text-muted">${timestamp}</span> <span class="${levelClass}">[${line.level}]</span> ${line.message}</div>`;
    });
    
    container.innerHTML = html || '<div class="text-muted">No log entries match current filters.</div>';
    
    if (autoScroll) {
        container.scrollTop = container.scrollHeight;
    }
}

// Event handlers
async function refreshProductionData() {
    document.getElementById('health-score').textContent = '--';
    DashboardUtils.showToast('Refreshing production data...', 'info');
    
    try {
        const response = await fetch('/api/metrics/production');
        if (!response.ok) throw new Error('Failed to refresh production data');
        
        productionData = await response.json();
        updateProductionDisplay();
        DashboardUtils.showToast('Production data refreshed', 'success');
    } catch (error) {
        console.error('Error refreshing production data:', error);
        DashboardUtils.showToast('Failed to refresh data', 'error');
    }
}

function updateChartsTimeRange(hours) {
    // In real implementation, this would fetch different time ranges
    DashboardUtils.showToast(`Time range updated to ${hours} hours`, 'info');
}

function clearLogView() {
    logLines = [];
    updateLogDisplay();
    DashboardUtils.showToast('Log view cleared', 'success');
}

function exportLogs() {
    const logs = {
        export_timestamp: new Date().toISOString(),
        total_entries: logLines.length,
        logs: logLines
    };
    
    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `production-logs-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    DashboardUtils.showToast('Logs exported successfully', 'success');
}

async function dismissAlert(alertId) {
    try {
        const response = await fetch(`/api/production/alerts/${alertId}/dismiss`, {
            method: 'POST'
        });
        
        if (response.ok) {
            DashboardUtils.showToast('Alert dismissed', 'success');
            refreshProductionData();
        } else {
            throw new Error('Failed to dismiss alert');
        }
    } catch (error) {
        DashboardUtils.showToast('Failed to dismiss alert', 'error');
    }
}

function resetDefaultThresholds() {
    DashboardUtils.showToast('Alert thresholds reset to defaults', 'success');
}

function exportConfiguration() {
    const config = {
        export_timestamp: new Date().toISOString(),
        alert_thresholds: productionData.alert_thresholds || {},
        monitoring_settings: {
            refresh_interval: 30,
            metric_retention_hours: 24,
            log_retention_count: 1000
        }
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `production-monitor-config-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    DashboardUtils.showToast('Configuration exported', 'success');
}

function testAlertSystem() {
    DashboardUtils.showToast('Alert system test triggered - check for test notifications', 'info');
}

function showProductionError(message) {
    const container = document.getElementById('active-alerts-container');
    container.innerHTML = `
        <div class="text-center py-4">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3 text-warning">Monitoring Error</h5>
            <p class="text-muted">${message}</p>
            <button class="btn btn-outline-primary" onclick="refreshProductionData()">
                <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
        </div>
    `;
}

// Filter event handlers
document.getElementById('log-level-filter').addEventListener('change', updateLogDisplay);
document.getElementById('log-search').addEventListener('input', updateLogDisplay);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (productionInterval) {
        clearInterval(productionInterval);
    }
});
</script>
{% endblock %}